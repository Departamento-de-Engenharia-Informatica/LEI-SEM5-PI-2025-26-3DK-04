<section class="manageVesselVisitNotifications">
  <div class="container">
    <h1>{{ t('vesselVisitNotifications.title') }}</h1>

    <div class="list-section">
      <h2>{{ t('vesselVisitNotifications.inProgressListTitle') }}</h2>
      <button (click)="loadInProgressNotifications()">
        {{ t('vesselVisitNotifications.refresh') }}
      </button>

      <div class="table-scroll-limit">
        <table *ngIf="inProgressNotifications.length > 0">
          <thead>
          <tr>
            <th>{{ t('vesselVisitNotifications.id') }}</th>
            <th>{{ t('vesselVisitNotifications.vesselName') }}</th>
            <th>{{ t('vesselVisitNotifications.status') }}</th>
            <th>{{ t('vesselVisitNotifications.arrival') }}</th>
            <th>{{ t('vesselVisitNotifications.departure') }}</th>
            <th>{{ t('vesselVisitNotifications.actions') }}</th>
          </tr>
          </thead>

          <tbody>
          <tr *ngFor="let n of inProgressNotifications">
            <td>{{ n.id }}</td>
            <td>{{ n.vesselName }}</td>
            <td>{{ n.status }}</td>
            <td>{{ n.arrivalTime ? (n.arrivalTime | date:'short') : '-' }}</td>
            <td>{{ n.departureTime ? (n.departureTime | date:'short') : '-' }}</td>
            <td>
              <button *ngIf="n.status === 'InProgress'" (click)="editNotification(n)">
                {{ t('vesselVisitNotifications.edit') }}
              </button>
              <button *ngIf="n.status === 'InProgress'" (click)="submitNotification(n)">
                {{ t('vesselVisitNotifications.submit') }}
              </button>
              <button class="secondary" (click)="withdrawNotification(n)">
                {{ t('vesselVisitNotifications.withdraw') }}
              </button>
              <button (click)="loadNotificationDetails(n)">
                {{ t('vesselVisitNotifications.view') }}
              </button>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <p *ngIf="inProgressNotifications.length === 0">
        {{ t('vesselVisitNotifications.noInProgress') }}
      </p>
    </div>

    <hr />

    <div class="list-section">
      <h2>{{ t('vesselVisitNotifications.submittedListTitle') }}</h2>
      <button (click)="loadSubmittedNotifications()">{{ t('vesselVisitNotifications.refresh') }}</button>

      <div class="table-scroll-limit">
        <table *ngIf="submittedNotifications.length > 0">
          <thead>
          <tr>
            <th>{{ t('vesselVisitNotifications.id') }}</th>
            <th>{{ t('vesselVisitNotifications.vesselName') }}</th>
            <th>{{ t('vesselVisitNotifications.status') }}</th>
            <th>{{ t('vesselVisitNotifications.arrival') }}</th>
            <th>{{ t('vesselVisitNotifications.departure') }}</th>
            <th>{{ t('vesselVisitNotifications.assignedDock') }}</th>
            <th>{{ t('vesselVisitNotifications.actions') }}</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let n of submittedNotifications">
            <td>{{ n.id }}</td>
            <td>{{ n.vesselName }}</td>
            <td>{{ n.status }}</td>
            <td>{{ n.arrivalTime ? (n.arrivalTime | date:'short') : '-' }}</td>
            <td>{{ n.departureTime ? (n.departureTime | date:'short') : '-' }}</td>
            <td>{{ n.assignedDock || '-' }}</td>
            <td>
              <button (click)="loadNotificationDetails(n)">
                {{ t('vesselVisitNotifications.view') }}
              </button>
              <button class="primary" (click)="openReviewModal(n, 'approve')" *ngIf="n.status === 'Submitted'">
                {{ t('vesselVisitNotifications.approve') }}
              </button>
              <button class="danger" (click)="openReviewModal(n, 'reject')" *ngIf="n.status === 'Submitted'">
                {{ t('vesselVisitNotifications.reject') }}
              </button>
              <button class="secondary" (click)="withdrawNotification(n)">
                {{ t('vesselVisitNotifications.withdraw') }}
              </button>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <p *ngIf="submittedNotifications.length === 0">
        {{ t('vesselVisitNotifications.noSubmitted') }}
      </p>
    </div>

    <hr />

    <div class="list-section">
      <h2>{{ t('vesselVisitNotifications.withdrawnListTitle') }}</h2>
      <button (click)="loadWithdrawnNotifications()">{{ t('vesselVisitNotifications.refresh') }}</button>

      <div class="table-scroll-limit">
        <table *ngIf="withdrawnNotifications.length > 0">
          <thead>
          <tr>
            <th>{{ t('vesselVisitNotifications.id') }}</th>
            <th>{{ t('vesselVisitNotifications.vesselName') }}</th>
            <th>{{ t('vesselVisitNotifications.status') }}</th>
            <th>{{ t('vesselVisitNotifications.arrival') }}</th>
            <th>{{ t('vesselVisitNotifications.departure') }}</th>
            <th>{{ t('vesselVisitNotifications.actions') }}</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let n of withdrawnNotifications">
            <td>{{ n.id }}</td>
            <td>{{ n.vesselName }}</td>
            <td>{{ n.status }}</td>
            <td>{{ n.arrivalTime ? (n.arrivalTime | date:'short') : '-' }}</td>
            <td>{{ n.departureTime ? (n.departureTime | date:'short') : '-' }}</td>
            <td>
              <button (click)="resumeNotification(n)">
                {{ t('vesselVisitNotifications.resume') }}
              </button>
              <button (click)="loadNotificationDetails(n)">
                {{ t('vesselVisitNotifications.view') }}
              </button>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <p *ngIf="withdrawnNotifications.length === 0">
        {{ t('vesselVisitNotifications.noWithdrawn') }}
      </p>
    </div>

    <hr />

    <form (ngSubmit)="createOrUpdateNotification()" class="form-section">
      <h2>
        {{ editing ? t('vesselVisitNotifications.editTitle') : t('vesselVisitNotifications.createTitle') }}
      </h2>
      <p *ngIf="editing">
        {{ t('vesselVisitNotifications.editingId') }}: <strong>{{ form.id }}</strong>
      </p>

      <div class="form-grid">
        <div class="form-group">
          <label>{{ t('vesselVisitNotifications.vessel') }}</label>
          <select [(ngModel)]="form.vesselId" name="vesselId" required>
            <option [ngValue]="null">{{ t('vesselVisitNotifications.selectVessel') }}</option>
            <option *ngFor="let v of vessels" [ngValue]="v.id">
              {{ v.name }} ({{ v.callsign || '-' }})
            </option>
          </select>
        </div>

        <div class="form-group">
          <label>{{ t('vesselVisitNotifications.representative') }}</label>
          <input [(ngModel)]="form.representativeId" name="representativeId"
                 placeholder="{{ t('vesselVisitNotifications.representativePlaceholder') }}" required />
        </div>

        <div class="form-group">
          <label>{{ t('vesselVisitNotifications.arrivalTime') }}</label>
          <input type="datetime-local" [(ngModel)]="form.arrivalTime" name="arrivalTime" required />
        </div>

        <div class="form-group">
          <label>{{ t('vesselVisitNotifications.departureTime') }}</label>
          <input type="datetime-local" [(ngModel)]="form.departureTime" name="departureTime" required />
        </div>

        <div class="form-group">
          <label>{{ t('vesselVisitNotifications.preferredDock') }}</label>
          <select [(ngModel)]="form.dockId" name="dockId">
            <option [ngValue]="null">{{ t('vesselVisitNotifications.selectDock') }}</option>
            <option *ngFor="let d of docks" [ngValue]="d.id">{{ d.name }}</option>
          </select>
        </div>
      </div>

      <div class="section-block">
        <h3>{{ t('vesselVisitNotifications.physicalResources') }}</h3>
        <div class="physical-resources-list">
          <div *ngFor="let p of physicalResources" class="physical-resource-item">
            <input type="checkbox"
                   [id]="'resource-' + p.id"
                   [value]="p.id"
                   (change)="onPhysicalResourceChange($event)"
                   [checked]="form.physicalResourceIds.includes(p.id)" />
            <label [for]="'resource-' + p.id">
              {{ p.description }} ({{ p.type }})
            </label>
          </div>
        </div>
      </div>

      <div class="section-block">
        <h3>{{ t('vesselVisitNotifications.staffListTitle') }}</h3>
        <div class="staff-list">
          <div *ngFor="let s of staff" class="staff-item">
            <input type="checkbox"
                   [id]="'staff-' + s.id"
                   [value]="s.id"
                   (change)="onStaffChange($event)"
                   [checked]="form.staffMemberIds.includes(s.id)" />
            <label [for]="'staff-' + s.id">{{ s.name }}</label>
          </div>
        </div>
      </div>

      <div class="section-block">
        <h3>{{ t('vesselVisitNotifications.loadingManifests') }}</h3>

        <div *ngFor="let m of form.loadingManifests; let mi = index" class="manifest">
          <div class="manifest-header">
            <strong>{{ t('vesselVisitNotifications.manifest') }} #{{ mi + 1 }}</strong>
            <button type="button" class="danger" (click)="removeLoadingManifest(mi)">
              {{ t('vesselVisitNotifications.remove') }}
            </button>
          </div>

          <div class="containers">
            <div *ngFor="let c of m.containers; let ci = index" class="container-row">
              <label>{{ t('vesselVisitNotifications.container') }} #{{ ci + 1 }}</label>

              <input
                type="number"
                step="0.01"
                [(ngModel)]="c.payloadWeight"
                name="load_payload_{{mi}}_{{ci}}"
                placeholder="{{ t('vesselVisitNotifications.payloadWeight') }}"
                required
              />

              <input
                [(ngModel)]="c.contentsDescription"
                name="load_contents_{{mi}}_{{ci}}"
                placeholder="{{ t('vesselVisitNotifications.contentsDescription') }}"
                required
              />

              <button type="button" class="secondary" (click)="removeLoadingContainer(mi, ci)">
                {{ t('vesselVisitNotifications.remove') }}
              </button>
            </div>

            <button type="button" (click)="addLoadingContainer(mi)">
              {{ t('vesselVisitNotifications.addContainer') }}
            </button>
          </div>
        </div>

        <button type="button" (click)="addLoadingManifest()">
          {{ t('vesselVisitNotifications.addManifest') }}
        </button>
      </div>

      <div class="section-block">
        <h3>{{ t('vesselVisitNotifications.unloadingManifests') }}</h3>

        <div *ngFor="let m of form.unloadingManifests; let mi = index" class="manifest">
          <div class="manifest-header">
            <strong>{{ t('vesselVisitNotifications.manifest') }} #{{ mi + 1 }}</strong>
            <button type="button" class="danger" (click)="removeUnloadingManifest(mi)">
              {{ t('vesselVisitNotifications.remove') }}
            </button>
          </div>

          <div class="containers">
            <div *ngFor="let c of m.containers; let ci = index" class="container-row">
              <label>{{ t('vesselVisitNotifications.container') }} #{{ ci + 1 }}</label>

              <input
                type="number"
                step="0.01"
                [(ngModel)]="c.payloadWeight"
                name="unload_payload_{{mi}}_{{ci}}"
                placeholder="{{ t('vesselVisitNotifications.payloadWeight') }}"
                required
              />

              <input
                [(ngModel)]="c.contentsDescription"
                name="unload_contents_{{mi}}_{{ci}}"
                placeholder="{{ t('vesselVisitNotifications.contentsDescription') }}"
                required
              />

              <button type="button" class="secondary" (click)="removeUnloadingContainer(mi, ci)">
                {{ t('vesselVisitNotifications.remove') }}
              </button>
            </div>

            <button type="button" (click)="addUnloadingContainer(mi)">
              {{ t('vesselVisitNotifications.addContainer') }}
            </button>
          </div>
        </div>

        <button type="button" (click)="addUnloadingManifest()">
          {{ t('vesselVisitNotifications.addManifest') }}
        </button>
      </div>

      <div class="section-block">
        <h3>{{ t('vesselVisitNotifications.crew') }}</h3>

        <div *ngFor="let cr of form.crew; let ci = index" class="crew-row">
          <input [(ngModel)]="cr.name" name="crew_name_{{ci}}" placeholder="{{ t('vesselVisitNotifications.crewName') }}" required />
          <input [(ngModel)]="cr.citizenId" name="crew_citizen_{{ci}}" placeholder="{{ t('vesselVisitNotifications.crewCitizenId') }}" required />
          <input [(ngModel)]="cr.nationality" name="crew_nationality_{{ci}}" placeholder="{{ t('vesselVisitNotifications.crewNationality') }}" required />

          <button type="button" class="danger" (click)="removeCrew(ci)">
            {{ t('vesselVisitNotifications.remove') }}
          </button>
        </div>

        <button type="button" (click)="addCrew()">
          {{ t('vesselVisitNotifications.addCrew') }}
        </button>
      </div>

      <div class="form-buttons">
        <button type="submit" class="primary" [disabled]="isSaving">
          {{ editing ? t('vesselVisitNotifications.saveChanges') : t('vesselVisitNotifications.createSubmit') }}
        </button>

        <button type="button" class="secondary" (click)="resetForm()">
          {{ t('vesselVisitNotifications.cancel') }}
        </button>
      </div>
    </form>

    <!-- ========== REVIEW MODAL (APPROVE/REJECT) ========== -->
    <div class="modal-overlay" *ngIf="showReviewModal" (click)="closeReviewModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <h2 *ngIf="reviewAction === 'approve'">{{ t('vesselVisitNotifications.approveTitle') }}</h2>
        <h2 *ngIf="reviewAction === 'reject'">{{ t('vesselVisitNotifications.rejectTitle') }}</h2>

        <div class="review-info">
          <p><strong>{{ t('vesselVisitNotifications.vesselName') }}:</strong> {{ reviewNotification?.vesselName }}</p>
          <p><strong>{{ t('vesselVisitNotifications.arrival') }}:</strong> {{ reviewNotification?.arrivalTime | date:'short' }}</p>
          <p><strong>{{ t('vesselVisitNotifications.departure') }}:</strong> {{ reviewNotification?.departureTime | date:'short' }}</p>
        </div>

        <div class="review-form">
          <!-- APPROVE FORM -->
          <div *ngIf="reviewAction === 'approve'">
            <div class="form-group">
              <label>{{ t('vesselVisitNotifications.assignDock') }}</label>
              <select [(ngModel)]="reviewForm.dockId" name="reviewDockId" required>
                <option [ngValue]="null">{{ t('vesselVisitNotifications.selectDock') }}</option>
                <option *ngFor="let d of docks" [ngValue]="d.id">{{ d.name }}</option>
              </select>
            </div>

            <div class="form-group">
              <label>{{ t('vesselVisitNotifications.officerId') }}</label>
              <input [(ngModel)]="reviewForm.officerId" name="reviewOfficerId"
                     placeholder="{{ t('vesselVisitNotifications.officerIdPlaceholder') }}" required />
            </div>
          </div>

          <!-- REJECT FORM -->
          <div *ngIf="reviewAction === 'reject'">
            <div class="form-group">
              <label>{{ t('vesselVisitNotifications.rejectReason') }}</label>
              <textarea [(ngModel)]="reviewForm.reason" name="reviewReason" rows="4"
                        placeholder="{{ t('vesselVisitNotifications.rejectReasonPlaceholder') }}" required></textarea>
            </div>

            <div class="form-group">
              <label>{{ t('vesselVisitNotifications.officerId') }}</label>
              <input [(ngModel)]="reviewForm.officerId" name="reviewOfficerId"
                     placeholder="{{ t('vesselVisitNotifications.officerIdPlaceholder') }}" required />
            </div>
          </div>
        </div>

        <div class="modal-buttons">
          <button class="primary" (click)="confirmReview()">{{ t('vesselVisitNotifications.confirm') }}</button>
          <button class="secondary" (click)="closeReviewModal()">{{ t('vesselVisitNotifications.cancel') }}</button>
        </div>
      </div>
    </div>

  </div>
</section>
